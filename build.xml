<!--===========================================================================
  This is the build file for the Pentaho Agile BI Project
  
  This build file will use the subfloor.xml file as the default build
  process and should only override the tasks that need to differ from
  the common build file.
  
  See subfloor.xml for more details
============================================================================-->
<project name="Agile BI" basedir="." default="jar" 
	xmlns:ivy="antlib:org.apache.ivy.ant" >
	
	<description>
	  This build file is used to create the Agile BI project
		and works with the subfloor.xml file.
	</description>

	<!-- Import the common_build.xml file which contains all the default tasks -->	
	<import file="build-res/subfloor-pkg.xml"/>

	<property name="platform.dist.dir"
	            value="../bi-platform-assembly/dist"
	            description="Location of platform assembly zip" />

	<property name="platform.unzip.dir"
	            value="${bin.dir}/platform-unzip"
	            description="Location of platform assembly zip" />
	
	<property name="kettle.dist.dir"
				value="../Kettle 3.2.3 Agile BI"
    			description="Location of kettle spoon zip" />
	
	<property name="pdiwithagilebi"
				value="pdi-ce-agile-bi" 
				description="Name of the pdi distribution with agile bi"/>
	
	<target name="resolve"
	          depends="resolve-default, resolve-test, ivy.check-releasable"
	          description="Retrieves all the dependent libraries" />

	<target name="dist-noresolve" depends="jar,package" description="Builds and packages the application" />
	<target name="dist" depends="resolve,jar,package" description="Builds and packages the application" />
	
	<target name="clean-dist">
		<delete dir="${dist.dir}" />
		<delete dir="${stage.dir}" />
		<delete dir="${platform.unzip.dir}" />
	</target>

    <!--
      AS STATED ABOVE, THE ONLY TASKS THAT SHOULD EXIST IN THIS BUILD FILE ARE
      THE TASKS THAT NEED TO DIFFER FROM THE DEFAULT IMPLEMENTATION OF THE TASKS
      FOUND IN subfloor.xml.
    --> 
	
  <target name="assemble.init">
    <mkdir dir="${stage.dir}" />
  </target>
	
  <target name="assemble" depends="assemble.init,assemble.copy-libs,assemble-embedded-server">
    <copy todir="${approot.stage.dir}" overwrite="true">
      <fileset dir="${package.resdir}" />
    </copy>
  	<delete>
		<fileset dir="${approot.stage.dir}/lib">
			
			<!-- first remove duplicate jars -->
			
			<!-- swt jars -->
			<include name="x86-*.jar"/>
			<include name="runtime-*.jar"/>
			<!-- xul jars -->
			<include name="pentaho-xul-*.jar"/>
			<!-- kettle jars -->
			<include name="kettle-*.jar"/>
			<!-- jetty jars -->
			<include name="jetty-*.jar"/>
			<!-- reporting libcore and libformula -->
			<include name="libbase-*.jar"/>
			<include name="libformula-*.jar"/>
			<!-- spring core -->
  			<include name="spring-core*.jar"/>
			<!-- mondrian -->
			<include name="mondrian-*.jar"/>
			<include name="eigenbase-*.jar"/>
			<include name="commons-math-*.jar"/>
			<include name="javacup-*.jar"/>
			
			<!-- second, remove unnecessary jars -->
			
			<!-- pentaho reporting -->
			<include name="pentaho-reporting-*.jar"/>
			<include name="lib*.jar"/>
			<!-- batik -->
			<include name="batik-*.jar"/>
			<!-- jackrabbit -->
  			<include name="jackrabbit-*.jar"/>
			<!-- jasperreports -->
  			<include name="jasperreports-*.jar"/>			
		</fileset>
  	</delete>
  </target>
	
	<target name="assemble-embedded-server">
		<!-- Step 1: Unzip a platform zip into staging dir -->
		<mkdir dir="${platform.unzip.dir}"/>
		<unzip dest="${platform.unzip.dir}">
			<fileset dir="${platform.dist.dir}">
			        <include name="biserver-ce-*.zip"/>
		    </fileset>
		</unzip>
		<!-- Step 2: Move / Remove platform as necessary -->

		<mkdir dir="${approot.stage.dir}/platform/webapps"/>
		<move file="${platform.unzip.dir}/biserver-ce/tomcat/webapps/pentaho" todir="${approot.stage.dir}/platform/webapps"/>
		<move file="${platform.unzip.dir}/biserver-ce/pentaho-solutions" todir="${approot.stage.dir}/platform"/>
		<!-- remove all the platform jar files, these are now part of the kettle classpath
		     and are brought over via ivy -->
		<delete>
			<fileset dir="${approot.stage.dir}/platform/webapps/pentaho/WEB-INF/lib">
				<include name="*.jar"/>
			</fileset>
		</delete>

		<delete dir="${approot.stage.dir}/platform/pentaho-solutions/system/data-access-plugin"/>
		<delete dir="${approot.stage.dir}/platform/pentaho-solutions/system/BIRT"/>
		<delete dir="${approot.stage.dir}/platform/pentaho-solutions/system/reporting"/>

	</target>
	
	<!-- this target builds a kettle release that includes the agile bi plugin -->
	<target name="kettle-w-plugin-dist">
		<unzip dest="${bin.dir}/kettle-dist">
			<fileset dir="${kettle.dist.dir}">
				<include name="pdi-ce-*.zip"/>
			</fileset>
		</unzip>
		<unzip dest="${bin.dir}/kettle-dist/plugins/spoon">
			<fileset dir="${dist.dir}">
				<include name="${package.basename}.zip"/>
			</fileset>
		</unzip>
		<zip destfile="${dist.dir}/${pdiwithagilebi}.zip">
			<zipfileset dir="${bin.dir}/kettle-dist" />
		</zip>
	</target>
</project>
